rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }



    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId);

      // Wedding subcollection (music, settings, etc.)
      match /wedding/{document=**} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    // Weddings collection
    match /weddings/{weddingId} {
      allow read, write: if isAuthenticated() &&
                            isOwner(resource.data.userId);
      allow create: if isAuthenticated() &&
                       isOwner(request.resource.data.userId) &&
                       request.resource.data.keys().hasAll(['userId', 'brideName', 'groomName', 'budget', 'style', 'region']) &&
                       request.resource.data.userId == request.auth.uid;
    }

    // Guests collection
    match /guests/{guestId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'firstName', 'lastName']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Tasks collection
    match /tasks/{taskId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'title', 'category', 'priority', 'status']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Budget items collection
    match /budgetItems/{budgetItemId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'name', 'category', 'budgetedAmount']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Timeline events collection
    match /timelineEvents/{eventId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'title', 'startTime', 'endTime', 'type']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Milestones collection
    match /milestones/{milestoneId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'title', 'type', 'targetDate', 'status', 'priority']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Gift items collection
    match /giftItems/{giftId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'name', 'category', 'price', 'quantity']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Seating plans collection
    match /seatingPlans/{planId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'name', 'layout']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Moodboard collection
    match /moodboards/{moodboardId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'userId', 'url', 'source', 'isFavorite', 'tags']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid &&
                       request.auth.uid == request.resource.data.userId;
    }

    // Menu items collection
    match /menuItems/{menuItemId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'name', 'category', 'estimatedQuantity']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Drink items collection
    match /drinkItems/{drinkItemId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'name', 'category', 'estimatedQuantity']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Accommodations collection
    match /accommodations/{accommodationId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'name', 'address']) &&
                       exists(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(request.resource.data.weddingId)).data.userId == request.auth.uid;
    }

    // Public collections (read-only for authenticated users)

    // Venues collection (public read, admin write)
    match /venues/{venueId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins can write (handled by Cloud Functions)
    }

    // Vendors collection (marketplace)
    match /vendors/{vendorId} {
      allow read: if resource.data.active == true ||
                     isOwner(resource.data.userId) ||
                     (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.userId;
      allow update: if isOwner(resource.data.userId) ||
                       (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
      allow delete: if isOwner(resource.data.userId) ||
                       (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
    }

    // Services collection
    match /services/{serviceId} {
      allow read: if resource.data.active == true ||
                     isOwner(resource.data.userId) ||
                     (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
      allow create: if isAuthenticated() &&
                       request.auth.token.role in ['vendor', 'admin', 'super_admin'];
      allow update: if isOwner(resource.data.userId) ||
                       (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
      allow delete: if isOwner(resource.data.userId) ||
                       (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
    }

    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if resource.data.verified == true ||
                     isOwner(resource.data.userId) ||
                     (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.userId;
      allow update: if isOwner(resource.data.userId) ||
                       (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
      allow delete: if isOwner(resource.data.userId) ||
                       (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
    }

    // Inquiries collection
    match /inquiries/{inquiryId} {
      allow read: if isOwner(resource.data.userId) ||
                     isOwner(resource.data.vendorUserId) ||
                     (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId) ||
                       isOwner(resource.data.vendorUserId) ||
                       (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
      allow delete: if isAuthenticated() && request.auth.token.role in ['admin', 'super_admin'];
    }

    // Favorites collection
    match /favorites/{favoriteId} {
      allow read, write: if isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && request.auth.token.role in ['admin', 'super_admin'];
    }

    // Analytics collection
    match /analytics/{analyticsId} {
      allow read: if isOwner(resource.data.vendorUserId) ||
                     (isAuthenticated() && request.auth.token.role in ['admin', 'super_admin']);
      allow write: if false; // Only server can write analytics
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId);
      allow update: if isOwner(resource.data.userId); // For marking as read
      allow create, delete: if isAuthenticated() && request.auth.token.role in ['admin', 'super_admin'];
    }

    // Wedding notifications collection
    match /weddingNotifications/{notificationId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId); // For marking as read
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.userId &&
                       request.resource.data.keys().hasAll(['userId', 'type', 'title', 'message', 'priority', 'category', 'read']);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Admin logs collection
    match /adminLogs/{logId} {
      allow read: if isAuthenticated() && request.auth.token.role in ['admin', 'super_admin'];
      allow write: if false; // Only server can write logs
    }

    // Task templates collection (public read, admin write)
    match /taskTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins can write
    }

    // Checklist completed items collection
    match /checklist_completed/{weddingId} {
      allow read, write: if isAuthenticated() &&
                            exists(/databases/$(database)/documents/weddings/$(weddingId)) &&
                            get(/databases/$(database)/documents/weddings/$(weddingId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       exists(/databases/$(database)/documents/weddings/$(weddingId)) &&
                       get(/databases/$(database)/documents/weddings/$(weddingId)).data.userId == request.auth.uid;
    }

    // Marketplace vendors collection
    match /marketplaceVendors/{vendorId} {
      // Anyone can read marketplace vendors (public marketplace)
      allow read: if true;

      // Anyone authenticated can create a vendor registration (will be pending approval)
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['name', 'category', 'email', 'phone']) &&
                       request.resource.data.verified == false &&
                       request.resource.data.status == 'pending';

      // Only admins can update/delete (handled by admin panel)
      allow update, delete: if false;
    }

    // Wedding websites collection
    match /weddingWebsites/{websiteId} {
      // Owner can read/write their own website
      allow read, write: if isAuthenticated() &&
                            resource.data.userId == request.auth.uid;

      // Owner can create website
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['weddingId', 'userId', 'customUrl', 'template']) &&
                       request.auth.uid == request.resource.data.userId;

      // Allow list/query for owner (to find website by weddingId)
      allow list: if isAuthenticated() &&
                     request.auth.uid != null;

      // Public read for published websites (for guests)
      allow get: if resource.data.isPublished == true;

      // Allow checking if document exists (for URL availability)
      allow get: if true;
    }

    // Notes collection
    match /notes/{noteId} {
      // Owner can read/write their own notes
      allow read, write: if isAuthenticated() &&
                            resource.data.userId == request.auth.uid;

      // Owner can create notes
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['title', 'content', 'weddingId', 'userId', 'createdAt', 'updatedAt']) &&
                       request.auth.uid == request.resource.data.userId;

      // Allow list/query for owner (to find notes by weddingId)
      allow list: if isAuthenticated() &&
                     request.auth.uid != null;
    }

    // RSVPs collection
    match /rsvps/{rsvpId} {
      // Owner can read all RSVPs for their wedding
      allow read: if isAuthenticated() &&
                     exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                     get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;

      // Owner can update/delete RSVPs
      allow update, delete: if isAuthenticated() &&
                               exists(/databases/$(database)/documents/weddings/$(resource.data.weddingId)) &&
                               get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.userId == request.auth.uid;

      // Anyone can create RSVP (guests submitting)
      allow create: if request.resource.data.keys().hasAll(['websiteId', 'weddingId', 'name', 'email', 'status', 'guestCount']) &&
                       exists(/databases/$(database)/documents/weddingWebsites/$(request.resource.data.websiteId)) &&
                       get(/databases/$(database)/documents/weddingWebsites/$(request.resource.data.websiteId)).data.isPublished == true;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
